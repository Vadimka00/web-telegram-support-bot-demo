<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f9f9fb;
      --text: #2d2d2d;
      --primary: #0066ff;
      --muted: #777;
      --table-head: #e9efff;
      --table-row: #ffffff;
      --table-alt: #f4f6fa;
      --border: #ddd;
      --radius: 6px;
    }

    body {
      margin: 0; padding: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 1rem;
    }

    .stats {
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }

    .search {
      margin: 1.5rem 0;
      display: flex;
      gap: 0.5rem;
    }

    .search input[type="text"] {
      flex: 1;
      padding: 0.6rem 0.8rem;
      font-size: 0.95rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      outline: none;
    }

    .search button {
      padding: 0.6rem 1rem;
      font-size: 0.95rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 0.75rem;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: var(--table-head);
      color: #444;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    tr:nth-child(even) {
      background: var(--table-alt);
    }

    select {
      font-size: 0.9rem;
      padding: 0.3rem;
      border-radius: var(--radius);
    }

    td[data-label="–Ø–∑—ã–∫"] {
      white-space: nowrap;
    }

    /* –í–Ω–µ—à–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: */
    .table-wrapper {
      overflow-x: auto;      /* –¢–∞–±–ª–∏—Ü–∞ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è */
      -webkit-overflow-scrolling: touch;
    }
    /* –ú–µ–¥–∏–∞–∑–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
      @media (max-width: 768px) {
        thead, th { display: none; }

        tr {
          display: grid;
          grid-template-areas:
            "id   role"
            "user user"
            "name name"
            "lang lang";
          grid-template-columns: auto 1fr;
          gap: 0.5rem;
          margin-bottom: 1rem;
          padding: 0.75rem;
          background: #fff;
          border: 1px solid var(--border);
          border-radius: var(--radius);
          box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }

        td {
          padding: 0.5rem;
          font-size: 0.9rem;
          border: none;
        }

        /* –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –ø–æ –æ–±–ª–∞—Å—Ç—è–º */
        td[data-label="ID"]       { grid-area: id; }
        td[data-label="–†–æ–ª—å"]     { grid-area: role; }
        td[data-label="Username"] { grid-area: user; }
        td[data-label="–ò–º—è"]      { grid-area: name; }
        td[data-label="–Ø–∑—ã–∫"]     { grid-area: lang; }
      }
  </style>
</head>
<body>

    {% extends "base.html" %}

    {% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äì –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}
    
    {% block content %}

  <h1>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>

  <div class="stats">
    <strong>–í—Å–µ–≥–æ:</strong> {{ total }} |
  {% for lang, count in lang_counts.items() %}
    <strong>{{ flags.get(lang, 'üè≥') }}</strong> {{ lang_names.get(lang, lang) }}: {{ count }}
  {% endfor %}
  </div>

<form class="search" method="get" action="/users">
  <input type="text" name="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ username" value="{{ query or '' }}">

  <select name="role">
    <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
    <option value="user" {% if selected_role == 'user' %}selected{% endif %}>user</option>
    <option value="moderator" {% if selected_role == 'moderator' %}selected{% endif %}>moderator</option>
    <option value="admin" {% if selected_role == 'admin' %}selected{% endif %}>admin</option>
  </select>
</form>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>–ò–º—è</th>
        <th>–Ø–∑—ã–∫</th>
        <th>–†–æ–ª—å</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
        <tr>
          <td data-label="ID">{{ user.id }}</td>
          <td data-label="Username">
            {% if user.username %}
              <a href="https://t.me/{{ user.username }}" target="_blank">
                @{{ user.username }}
              </a>
            {% else %}
              ‚Äì
            {% endif %}
          </td>
          <td data-label="–ò–º—è">{{ user.full_name }}</td>
          <td data-label="–Ø–∑—ã–∫">
            <form method="post" action="/users/set-language">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              {% set available_codes = available_languages | map(attribute="code") | list %}
              {% set lang_is_empty = not user.language_code %}
              {% set lang_is_unknown = user.language_code and user.language_code not in available_codes %}
              
              {% if lang_is_empty %}
                <select disabled>
                  <option selected>üè≥ –ù–µ —É–∫–∞–∑–∞–Ω</option>
                </select>
              {% else %}
                <select name="lang" onchange="this.form.submit()">
                  {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è–∑—ã–∫–∏ #}
                  {% for lang in available_languages %}
                    <option value="{{ lang.code }}"
                      {% if user.language_code == lang.code %}selected{% endif %}>
                      {{ flags.get(lang.code, 'üè≥') }} {{ lang_names.get(lang.code, lang.code) }}
                    </option>
                  {% endfor %}
                </select>
              {% endif %}
            </form>
          </td>
          <td data-label="–†–æ–ª—å">
            <form method="post" action="/users/set-role">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <select name="role" onchange="this.form.submit()">
                {% for r in ["user", "moderator", "admin"] %}
                  <option value="{{ r }}" {% if user.role == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="margin-top: 1.5rem; text-align: center;">
    {% if total_pages > 1 %}
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
          <strong style="margin: 0 4px;">[{{ p }}]</strong>
        {% else %}
          <a href="?page={{ p }}{% if query %}&q={{ query }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}" style="margin: 0 4px;">{{ p }}</a>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.querySelector("input[name='q']");
    const roleSelect = document.querySelector("select[name='role']");
    const form = document.querySelector(".search");

    // –ê–≤—Ç–æ—Å–∞–±–º–∏—Ç –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–æ–ª–∏
    roleSelect.addEventListener("change", () => {
      form.submit();
    });

    // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞ (debounce)
    let timeout;
    input.addEventListener("input", () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        form.submit();
      }, 2000);
    });
  });
</script>

  {% endblock %}

</body>
</html>